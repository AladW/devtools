#!/bin/bash
#
# finddeps - find packages that depend on a given depname
#

match=$1
tld=$(pwd)

if [[ -z $match ]]; then
	echo 'usage: finddeps <depname>'
	echo ''
	echo 'Find packages that depend on a given depname.'
	echo 'Run this script from the top-level directory of your ABS tree.'
	echo ''
	exit 0
fi

for d in "$(find . -type d)"; do
	cd "$d"
	if [[ -f PKGBUILD ]]; then
		unset pkgname depends makedepends
		. PKGBUILD
		for dep in "${depends[@]}"; do
			# lose the version comparator, if any
			depname=${dep%%[<>=]*}
			[[ $depname = $match ]] && echo "$d (depends)"
		done
		for dep in "${makedepends[@]}"; do
			# lose the version comparator, if any
			depname=${dep%%[<>=]*}
			[[ $depname = $match ]] && echo "$d (makedepends)"
		done
		for dep in "${optdepends[@]/:*}"; do
			# lose the version comaparator, if any
			depname=${dep%%[<>=]*}
			[[ $depname = $match ]] && echo "$d (optdepends)"
		done
	fi
	cd "$tld"
done
