#!/bin/bash

strip_url() {
	echo $1 | sed 's|^.*://.*/||g'
}

if [ ! -f PKGBUILD ]; then
	echo "This must be run in the directory of a built package."
	exit 1
fi

source PKGBUILD

if [ ! -f $pkgname-$pkgver-$pkgrel.pkg.tar.gz ]; then
	echo "You must have a built package to check."
	exit 1
fi

tmp=`pacman -Sp --noconfirm $pkgname`

if [ $? -ne 0 ]; then
	echo "Couldn't download previous package."
	exit 1
fi

pkgurl=`echo $tmp | rev | cut -d ' ' -f 1 | rev`

oldpkg=`strip_url $pkgurl`

if [ "$oldpkg" = "$pkgname-$pkgver-$pkgrel.pkg.tar.gz" ]; then
	echo "The built package is the one in the repo right now!"
	exit 1
fi

if [ ! -f $oldpkg ]; then
	wget $pkgurl
fi

tar tzf $oldpkg > filelist-old
tar tzf $pkgname-$pkgver-$pkgrel.pkg.tar.gz > filelist

sort -o filelist filelist
sort -o filelist-old filelist-old

diff filelist-old filelist

if diff filelist-old filelist | grep '\.so\.' > /dev/null 2>&1; then
	mkdir -p pkg
	cd pkg
	tar xzf ../$pkgname-$pkgver-$pkgrel.pkg.tar.gz > /dev/null
	for i in `diff ../filelist-old ../filelist | grep \> | grep \.so\. | awk '{print $2}'`; do
		echo -n "${i}: "
		objdump -p $i | grep SONAME
	done
else
	echo "No filename differences"
fi
